{% extends 'base.html' %} {% block content %}
<div class="attendance-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">Enregistrement des Présences</h1>
    <a href="{{ url_for('presences_jour') }}" class="btn btn-back">
      <i class="fas fa-arrow-left me-2"></i>Retour aux présences
    </a>
  </div>

  <div class="card info-card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h5><i class="fas fa-info-circle me-2"></i>Instructions</h5>
          <p class="mb-0">
            Sélectionnez "Entrée" pour enregistrer l'arrivée d'un employé et
            "Sortie" pour enregistrer son départ.
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="current-time">
            <i class="fas fa-clock me-2"></i>
            <span id="live-clock"
              >{{ now.strftime('%H:%M:%S') if now else '' }}</span
            >
          </div>
          <small class="text-muted"
            >{{ now.strftime('%d/%m/%Y') if now else '' }}</small
          >
        </div>
      </div>
    </div>
  </div>

  {% if employes %}
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-users me-2"></i>Liste des Employés</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover employees-table">
          <thead>
            <tr>
              <th>Matricule</th>
              <th>Nom Complet</th>
              <th>Statut</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for emp in employes %}
            <tr>
              <td>
                <span class="badge bg-secondary">{{ emp.matricule }}</span>
              </td>
              <td>
                <div class="employee-info">
                  <div class="employee-name">
                    {{ emp.nom }} {{ emp.prenom }}
                  </div>
                </div>
              </td>
              <td>
                {# Vérifier si l'employé a des présences et s'il est
                actuellement au travail #} {% if emp.presences %} {% set
                last_presence = emp.presences|sort(attribute='heure_entree',
                reverse=true)|first %} {% if last_presence and not
                last_presence.heure_sortie %}
                <span class="badge bg-warning">Au travail</span>
                {% else %}
                <span class="badge bg-light text-dark">Non arrivé</span>
                {% endif %} {% else %}
                <span class="badge bg-light text-dark">Non arrivé</span>
                {% endif %}
              </td>
              <td>
                <div class="d-flex justify-content-center gap-2">
                  <!-- Bouton Entrée -->
                  <form
                    method="post"
                    action="{{ url_for('entry', matricule=emp.matricule) }}"
                  >
                    <button class="btn btn-success btn-action">
                      <i class="fas fa-sign-in-alt me-1"></i>Entrée
                    </button>
                  </form>
                  <!-- Bouton Sortie -->
                  <form
                    method="post"
                    action="{{ url_for('exit_', matricule=emp.matricule) }}"
                  >
                    {# Désactiver le bouton Sortie si l'employé n'a pas de
                    présence en cours #} {% if emp.presences %} {% set
                    last_presence = emp.presences|sort(attribute='heure_entree',
                    reverse=true)|first %}
                    <button
                      class="btn btn-warning btn-action"
                      {%
                      if
                      not
                      last_presence
                      or
                      last_presence.heure_sortie
                      %}disabled{%
                      endif
                      %}
                    >
                      <i class="fas fa-sign-out-alt me-1"></i>Sortie
                    </button>
                    {% else %}
                    <button class="btn btn-warning btn-action" disabled>
                      <i class="fas fa-sign-out-alt me-1"></i>Sortie
                    </button>
                    {% endif %}
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-user-slash fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">Aucun employé enregistré</h4>
        <p class="text-muted">
          Vous devez d'abord ajouter des employés pour pouvoir enregistrer leurs
          présences.
        </p>
        <a href="{{ url_for('list_employes') }}" class="btn btn-primary mt-3">
          <i class="fas fa-plus-circle me-2"></i>Ajouter des employés
        </a>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style>
  .attendance-container {
    padding: 0 0.5rem;
  }

  .page-title {
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
  }

  .btn-back {
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    transition: all 0.3s;
  }

  .btn-back:hover {
    background-color: #5a6268;
    color: white;
    transform: translateY(-2px);
  }

  .info-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    background: linear-gradient(120deg, #f8f9fa, #e9ecef);
  }

  .current-time {
    font-size: 1.5rem;
    font-weight: 600;
    color: #4361ee;
  }

  .card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .card-header {
    background: linear-gradient(120deg, #4361ee, #3a56d4);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px 12px 0 0 !important;
  }

  .employees-table {
    margin-bottom: 0;
  }

  .employees-table th {
    background-color: #f8f9fa;
    color: #2c3e50;
    font-weight: 600;
    padding: 1rem;
    border-top: none;
  }

  .employees-table td {
    padding: 1rem;
    vertical-align: middle;
  }

  .employees-table tr {
    transition: background-color 0.2s;
  }

  .employees-table tr:hover {
    background-color: #f8f9fa;
  }

  .employee-info {
    display: flex;
    flex-direction: column;
  }

  .employee-name {
    font-weight: 500;
    color: #2c3e50;
  }

  .badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
  }

  .btn-action {
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.3s;
    border: none;
    min-width: 100px;
  }

  .btn-action:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
  }

  .btn-action:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .empty-state {
    max-width: 500px;
    margin: 2rem auto;
  }

  @media (max-width: 992px) {
    .d-flex {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }

    .btn-back {
      align-self: flex-start;
    }
  }

  @media (max-width: 768px) {
    .employees-table {
      font-size: 0.85rem;
    }

    .employees-table th,
    .employees-table td {
      padding: 0.75rem 0.5rem;
    }

    .btn-action {
      min-width: 80px;
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
    }

    .current-time {
      font-size: 1.25rem;
    }
  }
</style>

<script>
  // Horloge en temps réel
  function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString("fr-FR");
    const dateString = now.toLocaleDateString("fr-FR");

    const clockElement = document.getElementById("live-clock");
    if (clockElement) {
      clockElement.textContent = timeString;
    }
  }

  // Mettre à jour l'horloge toutes les secondes
  setInterval(updateClock, 1000);
  updateClock(); // Initial call
</script>
{% endblock %}
